@using formulate.app.Layouts.Kinds.Basic
@using formulate.app.Validations.Kinds.Regex
@using formulate.core.Extensions
@using formulate.core.Types
@model formulate.core.Models.FormViewModel
@{

    // Variables.
    var fields = Model.FormDefinition.Fields;
    var layout = Model.LayoutDefinition.Configuration as LayoutBasicConfiguration;


    // This view can only render basic layouts.
    if (layout == null)
    {
        return;
    }


    // A function that returns a validation configuration.
    var getValidationConfig = new Func<ValidationDefinition, object>(x =>
    {
        if (x.ValidationType == typeof(ValidationRegex))
        {
            //TODO: ...
        }
        return new { };
    });


    // Structure fields as an anonymous object suitable for serialization to JSON.
    var fieldsData = fields.Select(x => new
    {
        // The alias can be used to attach custom styles.
        alias = x.Alias,
        // The label can be used to instruct the user what data to enter.
        label = x.Label ?? x.Name,
        // The ID can be submitted to the server to uniquely identify the field.
        id = x.Id.ToString("N"),
        // This field type (e.g., "text", "checkbox") can be used to figure out how to render a field.
        fieldType = x.FieldType.Name.ConvertFieldTypeToAngularType(),
        validations = x.Validations.Select(y => new
        {
            id = y.Id.ToString("N"),
            alias = y.Alias,
            validationType = y.ValidationType.Name.ConvertValidationTypeToAngularType(),
            configuration = getValidationConfig(y)
        }).ToArray()
        //TODO: configuration (e.g., list values in a drop down).
    }).ToArray();


    // Structure layout as an anonymous object suitable for serialization to JSON.
    var rowsData = layout.Rows.Select(x => new
    {
        cells = x.Cells.Select(y => new
        {
            columns = y.ColumnSpan,
            fields = y.Fields.Select(z => new
            {
                id = z.FieldId.ToString("N")
            }).ToArray()
        }).ToArray()
    }).ToArray();


    // Convert to a JSON string that can be consumed by Angular.
    var angularModel = Json.Encode(new
    {
        // The name of the form can be use for analytics.
        name = Model.FormDefinition.Name,
        // The form alias can be used for custom styles.
        alias = Model.FormDefinition.Alias,
        // The random ID can be used to uniquely identify the form on the page.
        // Note that this random ID is regenerated on each page render.
        randomId = Guid.NewGuid().ToString("N"),
        // The fields in this form.
        fields = fieldsData,
        // The rows that define the form layout.
        rows = rowsData
    });

}

@* TODO: Until a directive is created, just outputting the raw JSON. *@
@Html.Raw(angularModel)